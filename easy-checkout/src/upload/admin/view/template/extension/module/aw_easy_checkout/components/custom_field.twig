{% set customFieldBody %}
    <form method="post" enctype="multipart/form-data" id="form-custom-field" class="form-horizontal">
        {% include 'extension/module/aw_easy_checkout/components/lang-inline.twig' with {
            sections: [
                {
                    id: 'custom-field-description-name',
                    namePrefix: 'custom_field_description[name]',
                    title: entry_name,
                    value: custom_field_description.name,
                    required: true,
                    placeholder: entry_name
                },
                {
                    id: 'custom-field-description-text-error',
                    namePrefix: 'custom_field_description[text_error]',
                    title: entry_text_error,
                    value: custom_field_description.text_error,
                    required: true,
                    placeholder: entry_text_error
                },
            ],
            languages: languages,
            defaultLanguageId: defaultLanguageId,
        } %}
        <div class="form-group">
            <label class="col-sm-3 control-label" for="input-location">{{ entry_location }}</label>
            <div class="col-sm-9">
                <select name="location" id="input-location" class="form-control">
                    <option value="customer" {{ location == 'customer' ? 'selected' : '' }}>
                        {{ text_customer }}
                    </option>
                    <option value="address" {{ location == 'address' ? 'selected' : '' }}>
                        {{ text_address }}
                    </option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label" for="input-type">{{ entry_type }}</label>
            <div class="col-sm-9">
                <select name="type" id="input-type" class="form-control">
                    <optgroup label="{{ text_choose }}">
                        <option value="select" {{ type == 'select' ? 'selected' : '' }}>{{ text_select }}</option>
                        <option value="radio" {{ type == 'radio' ? 'selected' : '' }}>{{ text_radio }}</option>
                        <option value="checkbox" {{ type == 'checkbox' ? 'selected' : '' }}>{{ text_checkbox }}</option>
                    </optgroup>
                    <optgroup label="{{ text_input }}">
                        <option value="text" {{ type == 'text' ? 'selected' : '' }}>{{ text_text }}</option>
                        <option value="textarea" {{ type == 'textarea' ? 'selected' : '' }}>{{ text_textarea }}</option>
                    </optgroup>
                    <optgroup label="{{ text_date }}">
                        <option value="date" {{ type == 'date' ? 'selected' : '' }}>{{ text_date }}</option>
                        <option value="time" {{ type == 'time' ? 'selected' : '' }}>{{ text_time }}</option>
                        <option value="datetime" {{ type == 'datetime' ? 'selected' : '' }}>{{ text_datetime }}</option>
                    </optgroup>
                </select>
            </div>
        </div>
        <div class="form-group" id="display-value">
            <label class="col-sm-3 control-label" for="input-value">{{ entry_value }}</label>
            <div class="col-sm-9">
                <input type="text" name="value" value="{{ value }}" placeholder="{{ entry_value }}" id="input-value" class="form-control" />
            </div>
        </div>
        <div class="form-group" id="display-validation">
            <label class="col-sm-3 control-label" for="input-validation"><span data-toggle="tooltip" title="{{ help_regex }}">{{ entry_validation }}</span></label>
            <div class="col-sm-9">
                <input type="text" name="validation" id="input-validation" value="{{ validation }}" placeholder="{{ text_regex }}"  class="form-control"/>
                <small class="help-block">{{ help_regex_empty }}</small>
                <div class="regex-patterns" style="margin-top: 10px;">
                    <small><strong>{{ text_common_patterns }}:</strong></small>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                        <button type="button" class="btn btn-xs btn-default regex-pattern-btn" data-pattern="{{ regex_pattern_digits }}" title="{{ text_regex_pattern_digits }}">
                            <i class="fa fa-hashtag"></i> {{ text_regex_pattern_digits }}
                        </button>
                        <button type="button" class="btn btn-xs btn-default regex-pattern-btn" data-pattern="{{ regex_pattern_letters }}" title="{{ text_regex_pattern_letters }}">
                            <i class="fa fa-font"></i> {{ text_regex_pattern_letters }}
                        </button>
                        <button type="button" class="btn btn-xs btn-default regex-pattern-btn" data-pattern="{{ regex_pattern_alphanumeric }}" title="{{ text_regex_pattern_alphanumeric }}">
                            <i class="fa fa-text-width"></i> {{ text_regex_pattern_alphanumeric }}
                        </button>
                        <button type="button" class="btn btn-xs btn-default regex-pattern-btn" data-pattern="{{ regex_pattern_email }}" title="{{ text_regex_pattern_email }}">
                            <i class="fa fa-envelope"></i> {{ text_regex_pattern_email }}
                        </button>
                        <button type="button" class="btn btn-xs btn-default regex-pattern-btn" data-pattern="{{ regex_pattern_phone }}" title="{{ text_regex_pattern_phone }}">
                            <i class="fa fa-phone"></i> {{ text_regex_pattern_phone }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">{{ entry_customer_group }}</label>
            <div class="col-sm-9">
                {% set customer_group_row = 0 %}
                {% for customer_group in customer_groups %}
                    <div class="checkbox">
                        <label>
                            <input type="checkbox"
                                   name="custom_field_customer_group[{{ customer_group_row }}][customer_group_id]"
                                   value="{{ customer_group.customer_group_id }}"
                                    {{ customer_group.customer_group_id in custom_field_customer_group ? 'checked' : '' }} />
                            {{ customer_group.name }}
                        </label>
                    </div>
                    {% set customer_group_row = customer_group_row + 1 %}
                {% endfor %}
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-3 control-label">{{ entry_required }}</div>
            <label class="col-xs-9 col-sm-6 checkbox-switch" for="custom-field-required">
                <input type="hidden" name="required" value="0" id="custom-field-required-off" {% if not required %}checked="checked"{% endif %} />
                <input type="checkbox" name="required" value="1" id="custom-field-required" {% if required %}checked="checked"{% endif %} />
            </label>
        </div>

        <div class="form-group">
            <div class="col-sm-3 control-label">{{ text_field_save_to_order }}</div>
            <label class="col-xs-9 col-sm-6 checkbox-switch" for="save_to_order">
                <input type="hidden" name="save_to_order" value="0" id="save_to_order-off" {% if not save_to_order %}checked="checked"{% endif %} />
                <input type="checkbox" name="save_to_order" value="1" id="save_to_order" {% if save_to_order %}checked="checked"{% endif %} />
            </label>
        </div>

        <div class="form-group">
            <div class="col-sm-3 control-label">{{ entry_status }}</div>
            <label class="col-xs-9 col-sm-6 checkbox-switch" for="custom-field-status">
                <input type="hidden" name="status" value="0" id="custom-field-status-off" {% if not status %}checked="checked"{% endif %} />
                <input type="checkbox" name="status" value="1" id="custom-field-status" {% if status %}checked="checked"{% endif %} />
            </label>
        </div>

        <table id="custom-field-value" class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <td class="text-left required">{{ entry_custom_value }}</td>
                <td class="text-right">{{ entry_sort_order }}</td>
                <td></td>
            </tr>
            </thead>
            <tbody>
            {% set custom_field_value_row = 0 %}
            {% for custom_field_value in custom_field_values %}
                <tr id="custom-field-value-row{{ custom_field_value_row }}">
                    <td class="text-left" style="width: 70%;"><input type="hidden" name="custom_field_value[{{ custom_field_value_row }}][custom_field_value_id]" value="{{ custom_field_value.custom_field_value_id }}" />
                        {% for language in languages %}
                            <div class="input-group"> <span class="input-group-addon"><img src="language/{{ language.code }}/{{ language.code }}.png" title="{{ language.name }}" /></span>
                                <input type="text" name="custom_field_value[{{ custom_field_value_row }}][custom_field_value_description][{{ language.language_id }}][name]" value="{{ custom_field_value.custom_field_value_description[language.language_id] ? custom_field_value.custom_field_value_description[language.language_id].name }}" placeholder="{{ entry_custom_value }}" class="form-control" />
                            </div>
                        {% endfor %}
                    </td>
                    <td class="text-right"><input type="text" name="custom_field_value[{{ custom_field_value_row }}][sort_order]" value="{{ custom_field_value.sort_order }}" placeholder="{{ entry_sort_order }}" class="form-control" /></td>
                    <td class="text-left"><button onclick="$('#custom-field-value-row{{ custom_field_value_row }}').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
                </tr>
                {% set custom_field_value_row = custom_field_value_row + 1 %}
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
                <td colspan="2"></td>
                <td class="text-left"><button type="button" onclick="addCustomFieldValue();" data-toggle="tooltip" title="{{ button_custom_field_value_add }}" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>
            </tr>
            </tfoot>
        </table>
    </form>
{% endset %}

{% set customFieldFooter %}
    <button onclick="saveCustomField();" id="button-save-custom-field" data-loading-text="{{ text_saving }}" class="btn btn-primary"><i class="fa fa-save"></i> {{ button_save }}</button>
{% endset %}

{% include 'extension/module/aw_easy_checkout/components/modal.twig' with {
    modal: {
        id: 'modal-add-custom-field',
        size: 'lg',
        title: text_form,
        body: customFieldBody,
        footer: customFieldFooter
    }
} %}

<script>
  function saveCustomField(){
    let action = 'index.php?route=extension/module/aw_easy_checkout/{{ method }}&';
      {% if custom_field_id %}
    action += 'custom_field_id={{ custom_field_id }}&{{ token_param }}';
      {% else %}
    action += '{{ token_param }}';
      {% endif %}
    $.ajax({
      type: 'post',
      url: action,
      data: $('#form-custom-field').serialize(),
      dataType: 'json',
      beforeSend: function() {
        $('#button-save-custom-field').button('loading');
      },
      complete: function() {
        $('#button-save-custom-field').button('reset');
      },
      success:function (json) {
        $('#form-custom-field .text-danger').remove();
        $('#form-custom-field .alert.alert-danger').remove();
        $('#v-tab_custom_field .alert.alert-success').remove();

        if (json['error']) {
          if (json['error']['name']) {
            let nameWarnings = json['error']['name'];
            let $inputGroups = $('.input-group');
            $.each(nameWarnings, function(languageId, errorMessage) {
              let $currentInputGroup = $inputGroups.find('input[name="custom_field_description[name][' + languageId + ']"]').closest('.input-group');
              $currentInputGroup.after('<div class="text-danger">' + errorMessage + '</div>');
            });
          }

          if (json['error']['custom_field_value']) {
            let customFieldValueErrors = json['error']['custom_field_value'];

            $.each(customFieldValueErrors, function(custom_field_value_id, languageErrors) {
              $.each(languageErrors, function(language_id, errorMessage) {
                let $row = $('#custom-field-value-row' + custom_field_value_id);
                let $inputGroup = $row.find('input[name="custom_field_value[' + custom_field_value_id + '][custom_field_value_description][' + language_id + '][name]"]').closest('.input-group');

                $inputGroup.after('<div class="text-danger">' + errorMessage + '</div>');
              });
            });
          }

          if (json['error']['warning']){
            $('#form-custom-field').prepend('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+ json['error']['warning'] +'<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
          }
        }

        if (json['success']) {
          let modal = $('#modal-add-custom-field');
          modal.modal('hide');
          modal.remove();

          let alert_success = $('<div class="alert alert-success"><i class="fa fa-exclamation-circle"></i> ' + json['success'] + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
          $('#v-tab_custom_field').before(alert_success);

          setTimeout(function() {
            alert_success.animate({ opacity: 0 }, 500, function() {
              alert_success.remove();
            });
          }, 4000);

          updateTable(json['custom_fields']);
          updateCustomFieldsDropDown(json['custom_fields']);
        }
      }
    });
  }

  $('select[name="type"]').on('change', function() {
    if (this.value === 'select' || this.value === 'radio' || this.value === 'checkbox') {
      $('#custom-field-value').show();
      $('#display-value, #display-validation').hide();
    } else {
      $('#custom-field-value').hide();
      $('#display-value, #display-validation').show();
    }

    if (this.value === 'date') {
      $('#display-value > div').html('<div class="input-group date"><input type="text" name="value" value="' + $('#input-value').val() + '" placeholder="{{ entry_value }}" data-date-format="YYYY-MM-DD" id="input-value" class="form-control" /><span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span></div>');
    } else if (this.value === 'time') {
      $('#display-value > div').html('<div class="input-group time"><input type="text" name="value" value="' + $('#input-value').val() + '" placeholder="{{ entry_value }}" data-date-format="HH:mm" id="input-value" class="form-control" /><span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span></div>');
    } else if (this.value === 'datetime') {
      $('#display-value > div').html('<div class="input-group datetime"><input type="text" name="value" value="' + $('#input-value').val() + '" placeholder="{{ entry_value }}" data-date-format="YYYY-MM-DD HH:mm" id="input-value" class="form-control" /><span class="input-group-btn"><button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button></span></div>');
    } else if (this.value === 'textarea') {
      $('#display-value > div').html('<textarea name="value" placeholder="{{ entry_value }}" id="input-value" class="form-control">' + $('#input-value').val() + '</textarea>');
    } else {
      $('#display-value > div').html('<input type="text" name="value" value="' + $('#input-value').val() + '" placeholder="{{ entry_value }}" id="input-value" class="form-control" />');
    }

    $('.date').datetimepicker({
      pickTime: false
    });

    $('.time').datetimepicker({
      pickDate: false
    });

    $('.datetime').datetimepicker({
      pickDate: true,
      pickTime: true
    });
  });

  $('select[name="type"]').trigger('change');

  $('.regex-pattern-btn').on('click', function(e) {
    e.preventDefault();
    let pattern = $(this).data('pattern');
    $('#input-validation').val(pattern);
  });

  let custom_field_value_row = {{ custom_field_value_row }};

  function addCustomFieldValue() {
    let html  = '<tr id="custom-field-value-row' + custom_field_value_row + '">';
    html += '  <td class="text-left" style="width: 70%;"><input type="hidden" name="custom_field_value[' + custom_field_value_row + '][custom_field_value_id]" value="" />';
      {% for language in languages %}
    html += '    <div class="input-group">';
    html += '      <span class="input-group-addon"><img src="language/{{ language.code }}/{{ language.code }}.png" title="{{ language.name }}" /></span><input type="text" name="custom_field_value[' + custom_field_value_row + '][custom_field_value_description][{{ language.language_id }}][name]" value="" placeholder="{{ entry_custom_value }}" class="form-control" />';
    html += '    </div>';
      {% endfor %}
    html += '  </td>';
    html += '  <td class="text-right"><input type="text" name="custom_field_value[' + custom_field_value_row + '][sort_order]" value="" placeholder="{{ entry_sort_order }}" class="form-control" /></td>';
    html += '  <td class="text-left"><button type="button" onclick="$(\'#custom-field-value-row' + custom_field_value_row + '\').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>';
    html += '</tr>';

    $('#custom-field-value tbody').append(html);

    custom_field_value_row++;
  }
</script>
